---
- name: Créer des utilisateurs et stocker les identifiants dans Vault (clé/valeur)
  hosts: vault
  become: true
  vars:
    ansible_python_interpreter: /usr/bin/python3

    users:
      - name: demo1
        password: motdepasse123
        comment: "Compte de test n°1"
        environment: developpement

      - name: toto
        password: toto
        comment: "Compte de production"
        environment: production

  tasks:

    - name: Créer les utilisateurs
      ansible.builtin.user:
        name: "{{ item.name }}"
        comment: "{{ item.comment }}"
        password: "{{ item.password }}"
        state: present
      loop: "{{ users }}"

    - name: Stocker les identifiants dans Vault (clé = nom utilisateur)
      community.hashi_vault.vault_kv2_write:
        url: "http://localhost:8200"
        token: "{{ vault_token }}" 
        mount_point: secret
        path: "{{ item.environment }}"
        data:
          "{{ { item.name: item.password | password_hash('sha512') } }}"
      loop: "{{ users }}"

